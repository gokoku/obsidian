#watson #raspberry_pi  #node-red 

---
2022-03-25  15:10

# watson  遠野AI のダイアログ設計

Watson のAssistant のダイアログの設計は柔軟性が高いので混沌化し易い。
なので、設計を収束させるために現段階での理解の元、今のシステム条件で考え方を決めていった。

## Raspberry pi のシステム設計による特殊性
Watson Assistants は基本的にテキストベースのチャットアプリにおいてうまく機能出来るようになっているようだ。

![[Pasted image 20220325163454.png]]

今回の raspberry pi をハードとLinux OSをプラットフォームにして設計したシステムでは、音声を Watson の外で取って入力にするため、一問一答で終了させる必要があった。


![[Pasted image 20220325164318.png]]


ということで、一問一答的パターンを何個か用意するシンプルな形を Watson Assistants を基本設計とした。

## Assistants の設計

### Assistants の概略
今回の目的のために必要なスキルは会話型の Dialog Skill だけをリンクした。

![[Pasted image 20220325133707.png]]

Dialog Skill とは対話型の仕組みを持つもので、Intents と Entities と Dialog で構成されている。


![[Pasted image 20220325134310.png]]

Dialog は対話フローを作るもので、Intents は粒度大きめの「ユーザーの目的」を担当し、Entities は粒度の小さい「言葉」を担当し、言い換えとか類義語などを吸収させるように出来るようだ。

![[Pasted image 20220325145909.png]]

### 基本パターンからノード設計

基本パターンは、お客さんを引き込む「導入部」、商品をタイプ別に薦める「おすすめ部」、会話終了の「エンディング部」とした。

その他補助的なものとして、対話の潤滑油的な繋ぎとしての「雑談部」、自分の名前などをいう「自己紹介部」、何が出来るのかいわゆる機能紹介する「アビリティ部」、どれにも当てはまらないものを受け取る「その他部」を加えた。

これを Dialog のノードとしてこのように設計した。

| ノード名           | パターン名     | 内容                                      |
| ------------------ | -------------- | ----------------------------------------- |
| Greetings          | 導入部         | 挨拶を受ける                              |
| Introduce Capacity | アビリティ部   | 自分の機能の紹介をする                    |
| About You          | 自己紹介部     | 自分の紹介をする                          |
| Recommend          | おすすめ部     | ユーザーへのおすすめをする                |
| Chat               | 雑談部         | 目的のないやりとりを受け持つ              |
| Joke reply         | ジョーク部     | Watson 側が用意した汎用例。無茶振り対応用 |
| Ending             | エンディング部 | 会話終了して離脱をする                    |
| anything_else      | その他部       | それ以外の対応をする                                          |


### ノード設計からインテント設定

インテントはユーザーの目的を補足するためのものらしいので、粒度大きめな感じにすることにした。

抽象度があまり高くならないように、1ノードに対して1インテントをアサインするようにしてシンプルを保つように心掛けて、以下のように用意した。

ここでユーザーの言葉から目的を推測するための具体的な言葉を設定する。

| インテント名                 | 対応ノードバターン名 | 対応する言葉の設定例                                      |
| ---------------------------- | -------------------- | --------------------------------------------------------- |
| \#General_Greetings          | 導入部               | おはよう、こんにちは、こんばんわ、はじめまして            |
| \#General_Agent_Capabilities | アビリティ部         | 出来ること教えて、何が答えられるの、何が出来るの          |
| \#General_About_You          | 自己紹介部           | あなたの名前は?、あなたのお年はいくつ、お名前は、お年は   |
| \#recommend                  | おすすめ部           | おすすめ、おすすめは何、おすすめを教えてください          |
| \#Chat                       | 雑談部               | いい天気ですね、そうですか、はい、なんで?、他には?        |
| \#General_Jokes              | ジョーク部           | あそびましょ、歌ってくれる?、私を驚かせて、面白い事言って |
| \#General_Ending             | エンディング部       | さようなら、またね、じゃね、また今度                      |
| \#General_Negative_Feedback  | 雑談部               | ばか、役に立たない、へんなの、使えない、会話にならない    |
| \#General_Positive_Feedback  | 雑談部               | すごい、すばらしいです、ためになりました、よかった        |



### インテント設定からエンティティ設定

ユーザーの言葉の入力から、特定の単語を補足するものがエンティティである。
エンティティで設定した言葉に反応して補足するので、この値を使って条件分岐が出来る。

特徴として、同義語を複数一つの単語に紐づけられるので、単語の抽象化をして意味付けの擬似対応が工夫次第で出来るようだ。

ここでは、各ノードで使うことを想定したエンティティを用意することで、ノードとインテントとエンティティを構造的に設計する方向を打ち出して進めた。

| エンティティ名 | 対応ノードパターン名 | 対応する言葉の設定例                  | 特記                       |
| -------------- | -------------------- | ------------------------------------- | -------------------------- |
| @crumb         | 雑談部               | はい、いい天気ですね、それから、天気  |                            |
| @gender        | おすすめ部           | 男性、女性、どちらでもない            | Slotで使用                 |
| @greeting      | 導入部               | こんにちは、こんばんわ、はじめまして  |                            |
| @joke          | ジョーク部           | 歌える?、面白いこと言って、遊びましょ |                            |
| @name          | 自己紹介部           | 名前                                  | 条件分岐で使用             |
| @old           | 自己紹介部           | 年齢                                  | 条件分岐で使用             |
| @reject        | エンディング部       | 遠慮します                            | おすすめ部の Slot でも使用 |
| @thank         | 雑談部               | ありがとう                            |                            |


### Slots を導入したノード

Dialog ノードの機能に、質問で情報を取得してそれによって対応出来るようにする Slots という機能がある。
この Slots とそれに応じて条件分岐が出来る Multiple conditoned reponses 機能を使って、性別と年齢 によっておすすめを変える処理を実装した。

\#recommend インテントを補足した時の Dialog は「おすすめ」ダイアログのシーケンスにして、以下のように性別の質問と年齢の質問をするようにした。

![[Pasted image 20220328104423.png]]

これで、性別の質問では @gender で補足出来た言葉を $gender 変数に入れ、年齢の質問で数字(@sys-number)が補足出来たら $age に入れる。

大事なフローとして、Manage handlers で質問への拒否を設定出来る。
ここでは、拒否の言葉を補足するように設定した @reject がインプットされた時、このシーケンスに入り質問を回避出来るようにした。


##### 一度設定した変数は保持される
一度設定された $gender と $age は保持されるので、この後誰が来ても質問しないで同じ答えをするようになる。

これは、ノードを抜ける時に null をセットしてやることで回避出来る。

設定は JSON Editor でする。

![[Pasted image 20220328113314.png]]

結局、$gender , $age と @gender , @age を処理する必要があったようだ。

![[スクリーンショット 2022-05-23 0.08.57.png | 500]]

# まとめ

後は実際に Assistants を動かして対応を見ながら調整する必要がある。

この時、構造的に設計をまとめて設計方針を明確に決めておくと調整がし易くなることがわかった。
それと共に、言葉自体が抽象性が強く構造的でなくても成立するので、調整していると \#intents と @Entities が交わってよく分からなくなり易いようだ。


